/* 
 * File:   main.c
 * Author: Thomas
 *
 * Created on 23. Juli 2017, 20:20
 */

#include <xc.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>        /* For uint8_t definition */
#include <stdbool.h>       /* For true/false definition */

#include "init.h"
#include "math.h"
#include "ecan.h"
#include "pwm.h"
#include <p33EP512MC506.h>
#include <libpic30.h>
#include <PPS.h>
#include <spi.h>
/*
 * 
 */

#define TABLES_LEN 128

const int16_t i_sinus[4096] = {0,50,101,151,201,251,302,352,402,452,503,553,603,653,704,754,804,854,905,955,1005,1055,1106,1156,1206,1256,1307,1357,1407,1457,1507,1558,1608,1658,1708,1758,1809,1859,1909,1959,2009,2059,2110,2160,2210,2260,2310,2360,2410,2461,2511,2561,2611,2661,2711,2761,2811,2861,2911,2962,3012,3062,3112,3162,3212,3262,3312,3362,3412,3462,3512,3562,3612,3662,3712,3761,3811,3861,3911,3961,4011,4061,4111,4161,4210,4260,4310,4360,4410,4460,4509,4559,4609,4659,4708,4758,4808,4858,4907,4957,5007,5056,5106,5156,5205,5255,5305,5354,5404,5453,5503,5552,5602,5651,5701,5750,5800,5849,5899,5948,5998,6047,6096,6146,6195,6245,6294,6343,
	6393,6442,6491,6540,6590,6639,6688,6737,6786,6836,6885,6934,6983,7032,7081,7130,7179,7228,7277,7326,7375,7424,7473,7522,7571,7620,7669,7718,7767,7815,7864,7913,7962,8010,8059,8108,8157,8205,8254,8303,8351,8400,8448,8497,8545,8594,8642,8691,8739,8788,8836,8885,8933,8981,9030,9078,9126,9175,9223,9271,9319,9367,9416,9464,9512,9560,9608,9656,9704,9752,9800,9848,9896,9944,9992,10039,10087,10135,10183,10231,10278,10326,10374,10421,10469,10517,10564,10612,10659,10707,10754,10802,10849,10897,10944,10992,11039,11086,11133,11181,11228,11275,11322,11370,11417,11464,11511,11558,11605,11652,11699,11746,11793,11840,11886,11933,11980,12027,12074,12120,12167,12214,12260,12307,12353,12400,12446,12493,
	12539,12586,12632,12679,12725,12771,12817,12864,12910,12956,13002,13048,13094,13141,13187,13233,13279,13324,13370,13416,13462,13508,13554,13599,13645,13691,13736,13782,13828,13873,13919,13964,14010,14055,14101,14146,14191,14236,14282,14327,14372,14417,14462,14507,14553,14598,14643,14688,14732,14777,14822,14867,14912,14956,15001,15046,15090,15135,15180,15224,15269,15313,15358,15402,15446,15491,15535,15579,15623,15667,15712,15756,15800,15844,15888,15932,15976,16019,16063,16107,16151,16195,16238,16282,16325,16369,16413,16456,16499,16543,16586,16630,16673,16716,16759,16802,16846,16889,16932,16975,17018,17061,17104,17146,17189,17232,17275,17317,17360,17403,17445,17488,17530,17573,17615,17657,17700,17742,17784,17827,17869,17911,17953,17995,18037,18079,18121,18163,
	18204,18246,18288,18330,18371,18413,18454,18496,18537,18579,18620,18661,18703,18744,18785,18826,18868,18909,18950,18991,19032,19072,19113,19154,19195,19236,19276,19317,19357,19398,19438,19479,19519,19560,19600,19640,19680,19721,19761,19801,19841,19881,19921,19961,20000,20040,20080,20120,20159,20199,20238,20278,20317,20357,20396,20436,20475,20514,20553,20592,20631,20670,20709,20748,20787,20826,20865,20904,20942,20981,21019,21058,21096,21135,21173,21212,21250,21288,21326,21364,21403,21441,21479,21516,21554,21592,21630,21668,21705,21743,21781,21818,21856,21893,21930,21968,22005,22042,22079,22116,22154,22191,22227,22264,22301,22338,22375,22411,22448,22485,22521,22558,22594,22631,22667,22703,22739,22776,22812,22848,22884,22920,22956,22991,23027,23063,23099,23134,
	23170,23205,23241,23276,23311,23347,23382,23417,23452,23487,23522,23557,23592,23627,23662,23697,23731,23766,23801,23835,23870,23904,23938,23973,24007,24041,24075,24109,24143,24177,24211,24245,24279,24312,24346,24380,24413,24447,24480,24514,24547,24580,24613,24647,24680,24713,24746,24779,24811,24844,24877,24910,24942,24975,25007,25040,25072,25105,25137,25169,25201,25233,25265,25297,25329,25361,25393,25425,25456,25488,25519,25551,25582,25614,25645,25676,25708,25739,25770,25801,25832,25863,25893,25924,25955,25986,26016,26047,26077,26108,26138,26168,26198,26229,26259,26289,26319,26349,26378,26408,26438,26468,26497,26527,26556,26586,26615,26644,26674,26703,26732,26761,26790,26819,26848,26876,26905,26934,26962,26991,27019,27048,27076,27104,27133,27161,27189,27217,
	27245,27273,27300,27328,27356,27384,27411,27439,27466,27493,27521,27548,27575,27602,27629,27656,27683,27710,27737,27764,27790,27817,27843,27870,27896,27923,27949,27975,28001,28027,28053,28079,28105,28131,28157,28182,28208,28234,28259,28284,28310,28335,28360,28385,28411,28436,28460,28485,28510,28535,28560,28584,28609,28633,28658,28682,28706,28730,28755,28779,28803,28827,28850,28874,28898,28922,28945,28969,28992,29016,29039,29062,29085,29108,29131,29154,29177,29200,29223,29246,29268,29291,29313,29336,29358,29380,29403,29425,29447,29469,29491,29513,29534,29556,29578,29599,29621,29642,29664,29685,29706,29728,29749,29770,29791,29812,29832,29853,29874,29894,29915,29936,29956,29976,29997,30017,30037,30057,30077,30097,30117,30136,30156,30176,30195,30215,30234,30253,
	30273,30292,30311,30330,30349,30368,30387,30406,30424,30443,30462,30480,30498,30517,30535,30553,30571,30589,30607,30625,30643,30661,30679,30696,30714,30731,30749,30766,30783,30800,30818,30835,30852,30868,30885,30902,30919,30935,30952,30968,30985,31001,31017,31033,31050,31066,31082,31097,31113,31129,31145,31160,31176,31191,31206,31222,31237,31252,31267,31282,31297,31312,31327,31341,31356,31371,31385,31400,31414,31428,31442,31456,31470,31484,31498,31512,31526,31539,31553,31567,31580,31593,31607,31620,31633,31646,31659,31672,31685,31698,31710,31723,31736,31748,31760,31773,31785,31797,31809,31821,31833,31845,31857,31869,31880,31892,31903,31915,31926,31937,31949,31960,31971,31982,31993,32004,32014,32025,32036,32046,32057,32067,32077,32087,32098,32108,32118,32128,
	32137,32147,32157,32166,32176,32185,32195,32204,32213,32223,32232,32241,32250,32258,32267,32276,32285,32293,32302,32310,32318,32327,32335,32343,32351,32359,32367,32375,32382,32390,32397,32405,32412,32420,32427,32434,32441,32448,32455,32462,32469,32476,32482,32489,32495,32502,32508,32514,32521,32527,32533,32539,32545,32550,32556,32562,32567,32573,32578,32584,32589,32594,32599,32604,32609,32614,32619,32624,32628,32633,32637,32642,32646,32650,32655,32659,32663,32667,32671,32674,32678,32682,32685,32689,32692,32696,32699,32702,32705,32708,32711,32714,32717,32720,32722,32725,32728,32730,32732,32735,32737,32739,32741,32743,32745,32747,32748,32750,32752,32753,32755,32756,32757,32758,32759,32760,32761,32762,32763,32764,32765,32765,32766,32766,32766,32767,32767,32767,
	32767,32767,32767,32767,32766,32766,32766,32765,32765,32764,32763,32762,32761,32760,32759,32758,32757,32756,32755,32753,32752,32750,32748,32747,32745,32743,32741,32739,32737,32735,32732,32730,32728,32725,32722,32720,32717,32714,32711,32708,32705,32702,32699,32696,32692,32689,32685,32682,32678,32674,32671,32667,32663,32659,32655,32650,32646,32642,32637,32633,32628,32624,32619,32614,32609,32604,32599,32594,32589,32584,32578,32573,32567,32562,32556,32550,32545,32539,32533,32527,32521,32514,32508,32502,32495,32489,32482,32476,32469,32462,32455,32448,32441,32434,32427,32420,32412,32405,32397,32390,32382,32375,32367,32359,32351,32343,32335,32327,32318,32310,32302,32293,32285,32276,32267,32258,32250,32241,32232,32223,32213,32204,32195,32185,32176,32166,32157,32147,
	32137,32128,32118,32108,32098,32087,32077,32067,32057,32046,32036,32025,32014,32004,31993,31982,31971,31960,31949,31937,31926,31915,31903,31892,31880,31869,31857,31845,31833,31821,31809,31797,31785,31773,31760,31748,31736,31723,31710,31698,31685,31672,31659,31646,31633,31620,31607,31593,31580,31567,31553,31539,31526,31512,31498,31484,31470,31456,31442,31428,31414,31400,31385,31371,31356,31341,31327,31312,31297,31282,31267,31252,31237,31222,31206,31191,31176,31160,31145,31129,31113,31097,31082,31066,31050,31033,31017,31001,30985,30968,30952,30935,30919,30902,30885,30868,30852,30835,30818,30800,30783,30766,30749,30731,30714,30696,30679,30661,30643,30625,30607,30589,30571,30553,30535,30517,30498,30480,30462,30443,30424,30406,30387,30368,30349,30330,30311,30292,
	30273,30253,30234,30215,30195,30176,30156,30136,30117,30097,30077,30057,30037,30017,29997,29976,29956,29936,29915,29894,29874,29853,29832,29812,29791,29770,29749,29728,29706,29685,29664,29642,29621,29599,29578,29556,29534,29513,29491,29469,29447,29425,29403,29380,29358,29336,29313,29291,29268,29246,29223,29200,29177,29154,29131,29108,29085,29062,29039,29016,28992,28969,28945,28922,28898,28874,28850,28827,28803,28779,28755,28730,28706,28682,28658,28633,28609,28584,28560,28535,28510,28485,28460,28436,28411,28385,28360,28335,28310,28284,28259,28234,28208,28182,28157,28131,28105,28079,28053,28027,28001,27975,27949,27923,27896,27870,27843,27817,27790,27764,27737,27710,27683,27656,27629,27602,27575,27548,27521,27493,27466,27439,27411,27384,27356,27328,27300,27273,
	27245,27217,27189,27161,27133,27104,27076,27048,27019,26991,26962,26934,26905,26876,26848,26819,26790,26761,26732,26703,26674,26644,26615,26586,26556,26527,26497,26468,26438,26408,26378,26349,26319,26289,26259,26229,26198,26168,26138,26108,26077,26047,26016,25986,25955,25924,25893,25863,25832,25801,25770,25739,25708,25676,25645,25614,25582,25551,25519,25488,25456,25425,25393,25361,25329,25297,25265,25233,25201,25169,25137,25105,25072,25040,25007,24975,24942,24910,24877,24844,24811,24779,24746,24713,24680,24647,24613,24580,24547,24514,24480,24447,24413,24380,24346,24312,24279,24245,24211,24177,24143,24109,24075,24041,24007,23973,23938,23904,23870,23835,23801,23766,23731,23697,23662,23627,23592,23557,23522,23487,23452,23417,23382,23347,23311,23276,23241,23205,
	23170,23134,23099,23063,23027,22991,22956,22920,22884,22848,22812,22776,22739,22703,22667,22631,22594,22558,22521,22485,22448,22411,22375,22338,22301,22264,22227,22191,22154,22116,22079,22042,22005,21968,21930,21893,21856,21818,21781,21743,21705,21668,21630,21592,21554,21516,21479,21441,21403,21364,21326,21288,21250,21212,21173,21135,21096,21058,21019,20981,20942,20904,20865,20826,20787,20748,20709,20670,20631,20592,20553,20514,20475,20436,20396,20357,20317,20278,20238,20199,20159,20120,20080,20040,20000,19961,19921,19881,19841,19801,19761,19721,19680,19640,19600,19560,19519,19479,19438,19398,19357,19317,19276,19236,19195,19154,19113,19072,19032,18991,18950,18909,18868,18826,18785,18744,18703,18661,18620,18579,18537,18496,18454,18413,18371,18330,18288,18246,
	18204,18163,18121,18079,18037,17995,17953,17911,17869,17827,17784,17742,17700,17657,17615,17573,17530,17488,17445,17403,17360,17317,17275,17232,17189,17146,17104,17061,17018,16975,16932,16889,16846,16802,16759,16716,16673,16630,16586,16543,16499,16456,16413,16369,16325,16282,16238,16195,16151,16107,16063,16019,15976,15932,15888,15844,15800,15756,15712,15667,15623,15579,15535,15491,15446,15402,15358,15313,15269,15224,15180,15135,15090,15046,15001,14956,14912,14867,14822,14777,14732,14688,14643,14598,14553,14507,14462,14417,14372,14327,14282,14236,14191,14146,14101,14055,14010,13964,13919,13873,13828,13782,13736,13691,13645,13599,13554,13508,13462,13416,13370,13324,13279,13233,13187,13141,13094,13048,13002,12956,12910,12864,12817,12771,12725,12679,12632,12586,
	12539,12493,12446,12400,12353,12307,12260,12214,12167,12120,12074,12027,11980,11933,11886,11840,11793,11746,11699,11652,11605,11558,11511,11464,11417,11370,11322,11275,11228,11181,11133,11086,11039,10992,10944,10897,10849,10802,10754,10707,10659,10612,10564,10517,10469,10421,10374,10326,10278,10231,10183,10135,10087,10039,9992,9944,9896,9848,9800,9752,9704,9656,9608,9560,9512,9464,9416,9367,9319,9271,9223,9175,9126,9078,9030,8981,8933,8885,8836,8788,8739,8691,8642,8594,8545,8497,8448,8400,8351,8303,8254,8205,8157,8108,8059,8010,7962,7913,7864,7815,7767,7718,7669,7620,7571,7522,7473,7424,7375,7326,7277,7228,7179,7130,7081,7032,6983,6934,6885,6836,6786,6737,6688,6639,6590,6540,6491,6442,
	6393,6343,6294,6245,6195,6146,6096,6047,5998,5948,5899,5849,5800,5750,5701,5651,5602,5552,5503,5453,5404,5354,5305,5255,5205,5156,5106,5056,5007,4957,4907,4858,4808,4758,4708,4659,4609,4559,4509,4460,4410,4360,4310,4260,4210,4161,4111,4061,4011,3961,3911,3861,3811,3761,3712,3662,3612,3562,3512,3462,3412,3362,3312,3262,3212,3162,3112,3062,3012,2962,2911,2861,2811,2761,2711,2661,2611,2561,2511,2461,2410,2360,2310,2260,2210,2160,2110,2059,2009,1959,1909,1859,1809,1758,1708,1658,1608,1558,1507,1457,1407,1357,1307,1256,1206,1156,1106,1055,1005,955,905,854,804,754,704,653,603,553,503,452,402,352,302,251,201,151,101,50,
	0,-50,-101,-151,-201,-251,-302,-352,-402,-452,-503,-553,-603,-653,-704,-754,-804,-854,-905,-955,-1005,-1055,-1106,-1156,-1206,-1256,-1307,-1357,-1407,-1457,-1507,-1558,-1608,-1658,-1708,-1758,-1809,-1859,-1909,-1959,-2009,-2059,-2110,-2160,-2210,-2260,-2310,-2360,-2410,-2461,-2511,-2561,-2611,-2661,-2711,-2761,-2811,-2861,-2911,-2962,-3012,-3062,-3112,-3162,-3212,-3262,-3312,-3362,-3412,-3462,-3512,-3562,-3612,-3662,-3712,-3761,-3811,-3861,-3911,-3961,-4011,-4061,-4111,-4161,-4210,-4260,-4310,-4360,-4410,-4460,-4509,-4559,-4609,-4659,-4708,-4758,-4808,-4858,-4907,-4957,-5007,-5056,-5106,-5156,-5205,-5255,-5305,-5354,-5404,-5453,-5503,-5552,-5602,-5651,-5701,-5750,-5800,-5849,-5899,-5948,-5998,-6047,-6096,-6146,-6195,-6245,-6294,-6343,
	-6393,-6442,-6491,-6540,-6590,-6639,-6688,-6737,-6786,-6836,-6885,-6934,-6983,-7032,-7081,-7130,-7179,-7228,-7277,-7326,-7375,-7424,-7473,-7522,-7571,-7620,-7669,-7718,-7767,-7815,-7864,-7913,-7962,-8010,-8059,-8108,-8157,-8205,-8254,-8303,-8351,-8400,-8448,-8497,-8545,-8594,-8642,-8691,-8739,-8788,-8836,-8885,-8933,-8981,-9030,-9078,-9126,-9175,-9223,-9271,-9319,-9367,-9416,-9464,-9512,-9560,-9608,-9656,-9704,-9752,-9800,-9848,-9896,-9944,-9992,-10039,-10087,-10135,-10183,-10231,-10278,-10326,-10374,-10421,-10469,-10517,-10564,-10612,-10659,-10707,-10754,-10802,-10849,-10897,-10944,-10992,-11039,-11086,-11133,-11181,-11228,-11275,-11322,-11370,-11417,-11464,-11511,-11558,-11605,-11652,-11699,-11746,-11793,-11840,-11886,-11933,-11980,-12027,-12074,-12120,-12167,-12214,-12260,-12307,-12353,-12400,-12446,-12493,
	-12539,-12586,-12632,-12679,-12725,-12771,-12817,-12864,-12910,-12956,-13002,-13048,-13094,-13141,-13187,-13233,-13279,-13324,-13370,-13416,-13462,-13508,-13554,-13599,-13645,-13691,-13736,-13782,-13828,-13873,-13919,-13964,-14010,-14055,-14101,-14146,-14191,-14236,-14282,-14327,-14372,-14417,-14462,-14507,-14553,-14598,-14643,-14688,-14732,-14777,-14822,-14867,-14912,-14956,-15001,-15046,-15090,-15135,-15180,-15224,-15269,-15313,-15358,-15402,-15446,-15491,-15535,-15579,-15623,-15667,-15712,-15756,-15800,-15844,-15888,-15932,-15976,-16019,-16063,-16107,-16151,-16195,-16238,-16282,-16325,-16369,-16413,-16456,-16499,-16543,-16586,-16630,-16673,-16716,-16759,-16802,-16846,-16889,-16932,-16975,-17018,-17061,-17104,-17146,-17189,-17232,-17275,-17317,-17360,-17403,-17445,-17488,-17530,-17573,-17615,-17657,-17700,-17742,-17784,-17827,-17869,-17911,-17953,-17995,-18037,-18079,-18121,-18163,
	-18204,-18246,-18288,-18330,-18371,-18413,-18454,-18496,-18537,-18579,-18620,-18661,-18703,-18744,-18785,-18826,-18868,-18909,-18950,-18991,-19032,-19072,-19113,-19154,-19195,-19236,-19276,-19317,-19357,-19398,-19438,-19479,-19519,-19560,-19600,-19640,-19680,-19721,-19761,-19801,-19841,-19881,-19921,-19961,-20000,-20040,-20080,-20120,-20159,-20199,-20238,-20278,-20317,-20357,-20396,-20436,-20475,-20514,-20553,-20592,-20631,-20670,-20709,-20748,-20787,-20826,-20865,-20904,-20942,-20981,-21019,-21058,-21096,-21135,-21173,-21212,-21250,-21288,-21326,-21364,-21403,-21441,-21479,-21516,-21554,-21592,-21630,-21668,-21705,-21743,-21781,-21818,-21856,-21893,-21930,-21968,-22005,-22042,-22079,-22116,-22154,-22191,-22227,-22264,-22301,-22338,-22375,-22411,-22448,-22485,-22521,-22558,-22594,-22631,-22667,-22703,-22739,-22776,-22812,-22848,-22884,-22920,-22956,-22991,-23027,-23063,-23099,-23134,
	-23170,-23205,-23241,-23276,-23311,-23347,-23382,-23417,-23452,-23487,-23522,-23557,-23592,-23627,-23662,-23697,-23731,-23766,-23801,-23835,-23870,-23904,-23938,-23973,-24007,-24041,-24075,-24109,-24143,-24177,-24211,-24245,-24279,-24312,-24346,-24380,-24413,-24447,-24480,-24514,-24547,-24580,-24613,-24647,-24680,-24713,-24746,-24779,-24811,-24844,-24877,-24910,-24942,-24975,-25007,-25040,-25072,-25105,-25137,-25169,-25201,-25233,-25265,-25297,-25329,-25361,-25393,-25425,-25456,-25488,-25519,-25551,-25582,-25614,-25645,-25676,-25708,-25739,-25770,-25801,-25832,-25863,-25893,-25924,-25955,-25986,-26016,-26047,-26077,-26108,-26138,-26168,-26198,-26229,-26259,-26289,-26319,-26349,-26378,-26408,-26438,-26468,-26497,-26527,-26556,-26586,-26615,-26644,-26674,-26703,-26732,-26761,-26790,-26819,-26848,-26876,-26905,-26934,-26962,-26991,-27019,-27048,-27076,-27104,-27133,-27161,-27189,-27217,
	-27245,-27273,-27300,-27328,-27356,-27384,-27411,-27439,-27466,-27493,-27521,-27548,-27575,-27602,-27629,-27656,-27683,-27710,-27737,-27764,-27790,-27817,-27843,-27870,-27896,-27923,-27949,-27975,-28001,-28027,-28053,-28079,-28105,-28131,-28157,-28182,-28208,-28234,-28259,-28284,-28310,-28335,-28360,-28385,-28411,-28436,-28460,-28485,-28510,-28535,-28560,-28584,-28609,-28633,-28658,-28682,-28706,-28730,-28755,-28779,-28803,-28827,-28850,-28874,-28898,-28922,-28945,-28969,-28992,-29016,-29039,-29062,-29085,-29108,-29131,-29154,-29177,-29200,-29223,-29246,-29268,-29291,-29313,-29336,-29358,-29380,-29403,-29425,-29447,-29469,-29491,-29513,-29534,-29556,-29578,-29599,-29621,-29642,-29664,-29685,-29706,-29728,-29749,-29770,-29791,-29812,-29832,-29853,-29874,-29894,-29915,-29936,-29956,-29976,-29997,-30017,-30037,-30057,-30077,-30097,-30117,-30136,-30156,-30176,-30195,-30215,-30234,-30253,
	-30273,-30292,-30311,-30330,-30349,-30368,-30387,-30406,-30424,-30443,-30462,-30480,-30498,-30517,-30535,-30553,-30571,-30589,-30607,-30625,-30643,-30661,-30679,-30696,-30714,-30731,-30749,-30766,-30783,-30800,-30818,-30835,-30852,-30868,-30885,-30902,-30919,-30935,-30952,-30968,-30985,-31001,-31017,-31033,-31050,-31066,-31082,-31097,-31113,-31129,-31145,-31160,-31176,-31191,-31206,-31222,-31237,-31252,-31267,-31282,-31297,-31312,-31327,-31341,-31356,-31371,-31385,-31400,-31414,-31428,-31442,-31456,-31470,-31484,-31498,-31512,-31526,-31539,-31553,-31567,-31580,-31593,-31607,-31620,-31633,-31646,-31659,-31672,-31685,-31698,-31710,-31723,-31736,-31748,-31760,-31773,-31785,-31797,-31809,-31821,-31833,-31845,-31857,-31869,-31880,-31892,-31903,-31915,-31926,-31937,-31949,-31960,-31971,-31982,-31993,-32004,-32014,-32025,-32036,-32046,-32057,-32067,-32077,-32087,-32098,-32108,-32118,-32128,
	-32137,-32147,-32157,-32166,-32176,-32185,-32195,-32204,-32213,-32223,-32232,-32241,-32250,-32258,-32267,-32276,-32285,-32293,-32302,-32310,-32318,-32327,-32335,-32343,-32351,-32359,-32367,-32375,-32382,-32390,-32397,-32405,-32412,-32420,-32427,-32434,-32441,-32448,-32455,-32462,-32469,-32476,-32482,-32489,-32495,-32502,-32508,-32514,-32521,-32527,-32533,-32539,-32545,-32550,-32556,-32562,-32567,-32573,-32578,-32584,-32589,-32594,-32599,-32604,-32609,-32614,-32619,-32624,-32628,-32633,-32637,-32642,-32646,-32650,-32655,-32659,-32663,-32667,-32671,-32674,-32678,-32682,-32685,-32689,-32692,-32696,-32699,-32702,-32705,-32708,-32711,-32714,-32717,-32720,-32722,-32725,-32728,-32730,-32732,-32735,-32737,-32739,-32741,-32743,-32745,-32747,-32748,-32750,-32752,-32753,-32755,-32756,-32757,-32758,-32759,-32760,-32761,-32762,-32763,-32764,-32765,-32765,-32766,-32766,-32766,-32767,-32767,-32767,
	-32767,-32767,-32767,-32767,-32766,-32766,-32766,-32765,-32765,-32764,-32763,-32762,-32761,-32760,-32759,-32758,-32757,-32756,-32755,-32753,-32752,-32750,-32748,-32747,-32745,-32743,-32741,-32739,-32737,-32735,-32732,-32730,-32728,-32725,-32722,-32720,-32717,-32714,-32711,-32708,-32705,-32702,-32699,-32696,-32692,-32689,-32685,-32682,-32678,-32674,-32671,-32667,-32663,-32659,-32655,-32650,-32646,-32642,-32637,-32633,-32628,-32624,-32619,-32614,-32609,-32604,-32599,-32594,-32589,-32584,-32578,-32573,-32567,-32562,-32556,-32550,-32545,-32539,-32533,-32527,-32521,-32514,-32508,-32502,-32495,-32489,-32482,-32476,-32469,-32462,-32455,-32448,-32441,-32434,-32427,-32420,-32412,-32405,-32397,-32390,-32382,-32375,-32367,-32359,-32351,-32343,-32335,-32327,-32318,-32310,-32302,-32293,-32285,-32276,-32267,-32258,-32250,-32241,-32232,-32223,-32213,-32204,-32195,-32185,-32176,-32166,-32157,-32147,
	-32137,-32128,-32118,-32108,-32098,-32087,-32077,-32067,-32057,-32046,-32036,-32025,-32014,-32004,-31993,-31982,-31971,-31960,-31949,-31937,-31926,-31915,-31903,-31892,-31880,-31869,-31857,-31845,-31833,-31821,-31809,-31797,-31785,-31773,-31760,-31748,-31736,-31723,-31710,-31698,-31685,-31672,-31659,-31646,-31633,-31620,-31607,-31593,-31580,-31567,-31553,-31539,-31526,-31512,-31498,-31484,-31470,-31456,-31442,-31428,-31414,-31400,-31385,-31371,-31356,-31341,-31327,-31312,-31297,-31282,-31267,-31252,-31237,-31222,-31206,-31191,-31176,-31160,-31145,-31129,-31113,-31097,-31082,-31066,-31050,-31033,-31017,-31001,-30985,-30968,-30952,-30935,-30919,-30902,-30885,-30868,-30852,-30835,-30818,-30800,-30783,-30766,-30749,-30731,-30714,-30696,-30679,-30661,-30643,-30625,-30607,-30589,-30571,-30553,-30535,-30517,-30498,-30480,-30462,-30443,-30424,-30406,-30387,-30368,-30349,-30330,-30311,-30292,
	-30273,-30253,-30234,-30215,-30195,-30176,-30156,-30136,-30117,-30097,-30077,-30057,-30037,-30017,-29997,-29976,-29956,-29936,-29915,-29894,-29874,-29853,-29832,-29812,-29791,-29770,-29749,-29728,-29706,-29685,-29664,-29642,-29621,-29599,-29578,-29556,-29534,-29513,-29491,-29469,-29447,-29425,-29403,-29380,-29358,-29336,-29313,-29291,-29268,-29246,-29223,-29200,-29177,-29154,-29131,-29108,-29085,-29062,-29039,-29016,-28992,-28969,-28945,-28922,-28898,-28874,-28850,-28827,-28803,-28779,-28755,-28730,-28706,-28682,-28658,-28633,-28609,-28584,-28560,-28535,-28510,-28485,-28460,-28436,-28411,-28385,-28360,-28335,-28310,-28284,-28259,-28234,-28208,-28182,-28157,-28131,-28105,-28079,-28053,-28027,-28001,-27975,-27949,-27923,-27896,-27870,-27843,-27817,-27790,-27764,-27737,-27710,-27683,-27656,-27629,-27602,-27575,-27548,-27521,-27493,-27466,-27439,-27411,-27384,-27356,-27328,-27300,-27273,
	-27245,-27217,-27189,-27161,-27133,-27104,-27076,-27048,-27019,-26991,-26962,-26934,-26905,-26876,-26848,-26819,-26790,-26761,-26732,-26703,-26674,-26644,-26615,-26586,-26556,-26527,-26497,-26468,-26438,-26408,-26378,-26349,-26319,-26289,-26259,-26229,-26198,-26168,-26138,-26108,-26077,-26047,-26016,-25986,-25955,-25924,-25893,-25863,-25832,-25801,-25770,-25739,-25708,-25676,-25645,-25614,-25582,-25551,-25519,-25488,-25456,-25425,-25393,-25361,-25329,-25297,-25265,-25233,-25201,-25169,-25137,-25105,-25072,-25040,-25007,-24975,-24942,-24910,-24877,-24844,-24811,-24779,-24746,-24713,-24680,-24647,-24613,-24580,-24547,-24514,-24480,-24447,-24413,-24380,-24346,-24312,-24279,-24245,-24211,-24177,-24143,-24109,-24075,-24041,-24007,-23973,-23938,-23904,-23870,-23835,-23801,-23766,-23731,-23697,-23662,-23627,-23592,-23557,-23522,-23487,-23452,-23417,-23382,-23347,-23311,-23276,-23241,-23205,
	-23170,-23134,-23099,-23063,-23027,-22991,-22956,-22920,-22884,-22848,-22812,-22776,-22739,-22703,-22667,-22631,-22594,-22558,-22521,-22485,-22448,-22411,-22375,-22338,-22301,-22264,-22227,-22191,-22154,-22116,-22079,-22042,-22005,-21968,-21930,-21893,-21856,-21818,-21781,-21743,-21705,-21668,-21630,-21592,-21554,-21516,-21479,-21441,-21403,-21364,-21326,-21288,-21250,-21212,-21173,-21135,-21096,-21058,-21019,-20981,-20942,-20904,-20865,-20826,-20787,-20748,-20709,-20670,-20631,-20592,-20553,-20514,-20475,-20436,-20396,-20357,-20317,-20278,-20238,-20199,-20159,-20120,-20080,-20040,-20000,-19961,-19921,-19881,-19841,-19801,-19761,-19721,-19680,-19640,-19600,-19560,-19519,-19479,-19438,-19398,-19357,-19317,-19276,-19236,-19195,-19154,-19113,-19072,-19032,-18991,-18950,-18909,-18868,-18826,-18785,-18744,-18703,-18661,-18620,-18579,-18537,-18496,-18454,-18413,-18371,-18330,-18288,-18246,
	-18204,-18163,-18121,-18079,-18037,-17995,-17953,-17911,-17869,-17827,-17784,-17742,-17700,-17657,-17615,-17573,-17530,-17488,-17445,-17403,-17360,-17317,-17275,-17232,-17189,-17146,-17104,-17061,-17018,-16975,-16932,-16889,-16846,-16802,-16759,-16716,-16673,-16630,-16586,-16543,-16499,-16456,-16413,-16369,-16325,-16282,-16238,-16195,-16151,-16107,-16063,-16019,-15976,-15932,-15888,-15844,-15800,-15756,-15712,-15667,-15623,-15579,-15535,-15491,-15446,-15402,-15358,-15313,-15269,-15224,-15180,-15135,-15090,-15046,-15001,-14956,-14912,-14867,-14822,-14777,-14732,-14688,-14643,-14598,-14553,-14507,-14462,-14417,-14372,-14327,-14282,-14236,-14191,-14146,-14101,-14055,-14010,-13964,-13919,-13873,-13828,-13782,-13736,-13691,-13645,-13599,-13554,-13508,-13462,-13416,-13370,-13324,-13279,-13233,-13187,-13141,-13094,-13048,-13002,-12956,-12910,-12864,-12817,-12771,-12725,-12679,-12632,-12586,
	-12539,-12493,-12446,-12400,-12353,-12307,-12260,-12214,-12167,-12120,-12074,-12027,-11980,-11933,-11886,-11840,-11793,-11746,-11699,-11652,-11605,-11558,-11511,-11464,-11417,-11370,-11322,-11275,-11228,-11181,-11133,-11086,-11039,-10992,-10944,-10897,-10849,-10802,-10754,-10707,-10659,-10612,-10564,-10517,-10469,-10421,-10374,-10326,-10278,-10231,-10183,-10135,-10087,-10039,-9992,-9944,-9896,-9848,-9800,-9752,-9704,-9656,-9608,-9560,-9512,-9464,-9416,-9367,-9319,-9271,-9223,-9175,-9126,-9078,-9030,-8981,-8933,-8885,-8836,-8788,-8739,-8691,-8642,-8594,-8545,-8497,-8448,-8400,-8351,-8303,-8254,-8205,-8157,-8108,-8059,-8010,-7962,-7913,-7864,-7815,-7767,-7718,-7669,-7620,-7571,-7522,-7473,-7424,-7375,-7326,-7277,-7228,-7179,-7130,-7081,-7032,-6983,-6934,-6885,-6836,-6786,-6737,-6688,-6639,-6590,-6540,-6491,-6442,
	-6393,-6343,-6294,-6245,-6195,-6146,-6096,-6047,-5998,-5948,-5899,-5849,-5800,-5750,-5701,-5651,-5602,-5552,-5503,-5453,-5404,-5354,-5305,-5255,-5205,-5156,-5106,-5056,-5007,-4957,-4907,-4858,-4808,-4758,-4708,-4659,-4609,-4559,-4509,-4460,-4410,-4360,-4310,-4260,-4210,-4161,-4111,-4061,-4011,-3961,-3911,-3861,-3811,-3761,-3712,-3662,-3612,-3562,-3512,-3462,-3412,-3362,-3312,-3262,-3212,-3162,-3112,-3062,-3012,-2962,-2911,-2861,-2811,-2761,-2711,-2661,-2611,-2561,-2511,-2461,-2410,-2360,-2310,-2260,-2210,-2160,-2110,-2059,-2009,-1959,-1909,-1859,-1809,-1758,-1708,-1658,-1608,-1558,-1507,-1457,-1407,-1357,-1307,-1256,-1206,-1156,-1106,-1055,-1005,-955,-905,-854,-804,-754,-704,-653,-603,-553,-503,-452,-402,-352,-302,-251,-201,-151,-101,-50 };


const uint16_t sinus[] = {
32768,34375,35979,37575,39160,40729,42279,43806,
45307,46777,48214,49613,50972,52287,53555,54772,
55937,57046,58097,59086,60012,60873,61665,62389,
63040,63619,64124,64553,64905,65180,65377,65495,
65535,65495,65377,65180,64905,64553,64124,63619,
63040,62389,61665,60873,60012,59086,58097,57046,
55937,54772,53555,52287,50972,49613,48214,46777,
45307,43806,42279,40729,39160,37575,35979,34375,
32767,31160,29556,27960,26375,24806,23256,21729,
20228,18758,17321,15922,14563,13248,11980,10763,
9598,8489,7438,6449,5523,4662,3870,3146,
2495,1916,1411,982,630,355,158,40,
1,40,158,355,630,982,1411,1916,
2495,3146,3870,4662,5523,6449,7438,8489,
9598,10763,11980,13248,14563,15922,17321,18758,
20228,21729,23256,24806,26375,27960,29556,31160
};

const int16_t x_sinus[128] = {-11200,-11161,-11122,-11083,-11044,-11006,-10968,-10930,-10894,-10858,-10823,-10789,-10756,-10723,-10692,-10663,
	-10634,-10607,-10582,-10557,-10535,-10514,-10494,-10477,-10461,-10447,-10434,-10424,-10415,-10409,-10404,-10401,
	-10400,-10401,-10404,-10409,-10415,-10424,-10434,-10447,-10461,-10477,-10494,-10514,-10535,-10557,-10582,-10607,
	-10634,-10663,-10692,-10723,-10756,-10789,-10823,-10858,-10894,-10930,-10968,-11006,-11044,-11083,-11122,-11161,
	-11200,-11239,-11278,-11317,-11356,-11394,-11432,-11470,-11506,-11542,-11577,-11611,-11644,-11677,-11708,-11737,
	-11766,-11793,-11818,-11843,-11865,-11886,-11906,-11923,-11939,-11953,-11966,-11976,-11985,-11991,-11996,-11999,
	-12000,-11999,-11996,-11991,-11985,-11976,-11966,-11953,-11939,-11923,-11906,-11886,-11865,-11843,-11818,-11793,
	-11766,-11737,-11708,-11677,-11644,-11611,-11577,-11542,-11506,-11470,-11432,-11394,-11356,-11317,-11278,-11239 };

uint8_t ptr_sinus = 0;


#define PPSIn(fn,pin)    iPPSInput(IN_FN_PPS##fn,IN_PIN_PPS##pin)
#define PPSOut(fn,pin)    iPPSOutput(OUT_PIN_PPS##pin,OUT_FN_PPS##fn)

//#define ADC_BUSY PORTEbits.RE15
#define ADC_BUSY PORTDbits.RD5
#define ADC_CNV  LATDbits.LATD6
#define ADC_SS   LATCbits.LATC9
#define DAC_SS   LATBbits.LATB9

//#define DAC_SS   LATCbits.LATC

uint16_t counter = 0;
uint8_t ptr_count = 0;
double DC = 0;
int u_k1 = 0;
int u_xk1 = 0;
int xsoll = 0;
double u_m = 0;
int32_t u_ts = 0;
int start_adc = 0;
int imax = 19200;    // in pwm
int ioffset = 0;
uint16_t period = 20480;  // in ms
int konst = 0;
uint8_t trigger_adc = 0;
uint8_t trigger_calc = 0;
uint8_t adc_finish = 0;
int16_t CH[8];
    int16_t adc_i1 = 0;
    int16_t adc_i2 = 0;  
    uint8_t counter_can = 0;
    uint8_t no_receive = 0;
    uint16_t lockin_ref = 0;
    uint16_t count_uavg = 0;
    int16_t m1 = 0, m2 = 0;
    
int32_t uavg1 = 0, uavg2 = 0, uavg1out = 0, uavg2out = 0, uavg1outavg = 0, uavg2outavg = 0;
int16_t uli1[128];
int16_t uli2[128];

int16_t step = 0, dir = 1;
uint16_t imode = 2;
    
    float Kxp = 10;
    float Kxi = 0.01;
    
        
    WORD data[12] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};
    

//void __attribute__((__interrupt__, __auto_psv__)) _T1Interrupt(void);
void __attribute__((__interrupt__,no_auto_psv)) _PWM1Interrupt(void);
void __attribute__((__interrupt__,no_auto_psv)) _PWM2Interrupt(void);
void __attribute__((__interrupt__,no_auto_psv)) _DMA1Interrupt(void);
void __attribute__((__interrupt__,no_auto_psv)) _SPI2Interrupt(void);
void __attribute__((__interrupt__,no_auto_psv)) _DMA2Interrupt(void);
void __attribute__((__interrupt__,no_auto_psv)) _DMA3Interrupt(void);
void __attribute__((__interrupt__,no_auto_psv)) _INT1Interrupt(void);
/*void __attribute__((__interrupt__, no_auto_psv)) _AD1Interrupt(void);*/


void CfgDma0SpiTx ( void );
void CfgDma1SpiRx( void );
void CfgSPI1Master( void );
void ProcessSpiRxSamples( __eds__ uint16_t * );

// used to switch the receiving buffer
uint16_t            rxDmaBuffer = 0;
#ifdef _HAS_DMA_
__eds__ uint16_t    SPI1RxBuffA[16] __attribute__( (eds, space(dma)) );
__eds__ uint16_t    SPI1RxBuffB[16] __attribute__( (eds, space(dma)) );
__eds__ uint16_t    SPI1TxBuffA[16] __attribute__( (eds, space(dma)) );
__eds__ uint16_t    SPI1TxBuffB[16] __attribute__( (eds, space(dma)) );

#else
uint16_t            SPI1RxBuffA[12] __attribute__( (space(xmemory)) );
uint16_t            SPI1RxBuffB[12] __attribute__( (space(xmemory)) );
uint16_t            SPI1TxBuffA[12] __attribute__( (space(xmemory)) );
uint16_t            SPI1TxBuffB[12] __attribute__( (space(xmemory)) );
#endif

void timer_dac_init(void);
    
int main(int argc, char** argv) {

    
    ConfigureOscillator();
    // GPIO
      TRISBbits.TRISB6 = 0;   // output
      TRISBbits.TRISB7 = 0;   // output
      TRISBbits.TRISB8 = 0;   // output
    //  TRISD = 0x0000;   // outputs
    //  TRISA = 0xFFFF;   // inputs
      TRISAbits.TRISA10 = 0;
      TRISCbits.TRISC10 = 0;    // 0:output, 1:input
      
     
    LATDbits.LATD5 = 0;
    LATEbits.LATE15 = 0;
   //     if (0) {
  /*   while(1) {

        LATDbits.LATD5 = 0;
        LATDbits.LATD5 = 1;
        LATDbits.LATD5 = 0;
        LATDbits.LATD5 = 1;
        LATDbits.LATD5 = 0;
   }
   */

    /* Place code to set device speed here. For this example the device speed should be set at
    40 MHz (i.e., the device is operating at 40 MIPS). */
    //ConfigureDeviceClockFor40MIPS();
    /* The dsPIC33E device features I/O remap. This I/O remap configuration for the ECAN
    module can be performed here. */
    //SetIORemapForECANModule();
     
    /* Set up the ECAN1 module to operate at 250 kbps. The ECAN module should be first placed
    in configuration mode. */
    ecan_init();
    pwm_init();

    data[0] = 0x1234;       //wofür muss das Array hier beschrieben werden, wird sofort in der schleife geändert
    data[1] = 0x5678;
    data[2] = 0xcfcf;
    data[3] = 0xe5e1;
    

  //  DMA1STAL = (unsigned int) &ecan1MsgRxBuf;
  //  DMA1STAH = (unsigned int) &ecan1MsgRxBuf;    

    
   // ecan_send_message(data,sizeof(data),VALVE_ID); 
        
    
    // SPI - SERIAL PERIPHERAL INTERFACE FÜR ADC
    
    PPSIn (_SDI2,_RP54);    // RC6
    PPSOut(_SDO2,_RP55);    // RC7
    PPSOut(_SCK2,_RP56);    // RC8
    PPSOut(_SS2, _RP57);    // RC9
    //PPSIn (_INT1,_RPI95);    // RE15
    PPSIn (_INT1,_RPI121);    // RE15
    
    TRISCbits.TRISC6 = 1;   // 0:output, 1:input
    TRISCbits.TRISC7 = 0;   // 0:output, 1:input
    TRISCbits.TRISC8 = 0;   // 0:output, 1:input
    TRISCbits.TRISC9 = 0;   // 0:output, 1:input
    TRISBbits.TRISB9 = 0;   // 0:output, 1:input
    TRISEbits.TRISE15 = 1;   // 0:output, 1:input
    TRISGbits.TRISG9 = 1;   // 0:output, 1:input 
    
    TRISDbits.TRISD5 = 1;   // input
    TRISDbits.TRISD6 = 0;   // output
    
    // lockin amp ref signal
    TRISFbits.TRISF0 = 0;   // 0:output, 1:input
    TRISFbits.TRISF1 = 0;   // 0:output, 1:input
    
    int16_t temp;
    int16_t adc_val;  
    uint8_t busy_old = 0;
    int32_t isoll = 0;

    TRISBbits.TRISB8 = 0;   // output
    TRISBbits.TRISB7 = 0;   // output

    // SPI init with DMA
    //Methoden zur Initialisierung
    InitSPIBuff();
    CfgDma0SpiTx();
    CfgDma1SpiRx();
    CfgSpi1Master();
    timer_dac_init();
    
    INTCON2bits.GIE = 1;            //Global Interrupt enabled bit, aktiviert global alle interrupts von interrupt2 
    _LATB8 = 0;                 //verwendung in int1 interrupt und dma3 Interrupt; Definition ?
    int16_t iint = 0;
            
    while(1) {
     
    // current control
    //Steuerung der Vollbrücke
        if (trigger_calc && !adc_finish) {
            data[0] = counter;
            ClrWdt();               //????
            _LATC10 = 1;
            //if (start_adc == 2) {
                //if (adc_i1 > 0) 
                    data[2] = adc_i1 + adc_i2;
                    data[3] = CH[1];
                    
                    data[4] = xsoll;//CH[2];
                    data[5] = CH[4];//SPI1TxBuffA[1];//// normal isoll
                    data[6] = u_ts;
                    
                    data[7] = CH[5];    // lockin1
                    data[8] = CH[6];    // lockin2
                    
                    data[7] = uavg1outavg;    // avg lockin1
                    data[8] = uavg2outavg;    // avg lockin2
                    
                    data[7] = m1;    // avg lockin1
                    data[8] = m2;    // avg lockin2
                    
                //    data[1] = isoll;
                //else
                //    data[2] = adc_i2;
                //ecan_send_message(data,2,VALVE_ID);

                int16_t div = 0;
                
                        double Kp = 0.1; // 0,1
                        double Ki = 0.3; // 0,3
                        
                switch (imode) {//imode mit LabView einstellbar
                    case 0:  
                        isoll = imax;
                        break;
                    case 1:
                        //_LATC10 = 1;
                        //isoll = imax*sin(2*3.1415*(float)counter/period) + ioffset;
                        /*float itemp = 2*3.1415*(float)counter/period;
                        _LATC10 = 0;
                        _LATC10 = 1;
                        isoll = sin(itemp);
                        _LATC10 = 0;*/
                        // interpolate
                            // example: sinus with 4096 steps
                            // period is 20480 -> t=0..20480 
                            // index t/5=t*4096/20480   ex: t=7 : 1
                            // rest  modulo t%5=t%(20480/4096) -> ex: t=7 : moderg=2
                            // 
                        div = period / 4096;            //period auch über LabView einstellbar
                        int16_t mod = counter%div;      //Entspricht dem Abstand Zwischen zwei Wertepunkten
                        uint16_t idx0 = counter/div;    //Aktueeler Punkt des Datensatzes
                        uint16_t idx1; // = 0;            wird in der if anweisung festgelegt
                        if (idx0 == 4095) {
                            idx1 = 0;
                        } else {
                            idx1 = idx0 + 1;            //entspricht dem nächsten Wert oder wird zurückgesetzt wenn der SInus zu ende ist
                        }
                        int16_t i0 = i_sinus[idx0];     
                        int16_t i1 = i_sinus[idx1];     //Abrufen des Sinus
                        iint = ((i1 - i0) * mod) / div; //Berechnung der Interpolation zwischen zwei werten
                        isoll = (((int32_t)(i0 + iint) * imax) >> 15);  //Berechnung des endgültigen Stromwertes für die Vollbrücke
                        //_LATC10 = 0;
                        
                        break;
                    case 2: // stepwise, steps: 16
                        isoll = step * (imax >> 4);
                        
                        Kp = 0.001; // 0,0
                        Ki = 0.03; // 0,001
                        break;
                    default:
                        break;
                }
                    
                //isoll = 2500;//1860; //2500; //3100+600*sin(2*3.1415*(double)counter/10000); // 0,5 A -> 1000
               // int isoll = 2100;
                int iist = data[2];  // 0,5 A -> 0,05 V  -> ca. 60
                int u_k0 = isoll - iist;
                DC = PDC1 + (Kp + Ki)* (double)u_k0 - Kp*u_k1;
                u_k1 = u_k0;
                //DC = 3000;
               
            // ohne Stromregelung
            /*    DC = 6250+3125*sin(2*3.1415*(double)counter/period);*/
                PDC1 = PDC2 = DC;
            //}
            data[1] = isoll;            //soll Srom der Magnetfeldspulen an LabView übermitteln
         //   start_adc = 0;
            trigger_calc = 0;
            _LATC10 = 0;
        }
        
        if (adc_finish) {
            _LATC10 = 1;
        // mit Wegregelung
            xsoll = ((x_sinus[ptr_sinus] + 11200)/2) - 8500;//8064;  //Signal, welches sich durch die Regelstrecke einstellen soll
            int xist = CH[4];    
            // Mittelwert: -2,52 V * 3200 µC/V = 8064
            // +- 0,5 mm -> +- 0,125 V
            Kxp = 16;   // 16                 //P anteil des Reglers 
            Kxi = 0.05; // 0.02                //I Anteil des Reglers
            int u_xk0 = xsoll - xist;
            //_LATC10 = 1;
            u_m = u_m + (Kxp + Kxi)* (double)u_xk0 - Kxp*u_xk1; // PI Regler
            //u_m = u_m + Kxp * (int32_t)u_xk0 + ((int32_t)u_xk0 >> 6) - Kxp*(int32_t)u_xk1; // PI Regler
            //_LATC10 = 0;
            //u_m = Kxp * u_xk0; // P Regler
            u_xk1 = u_xk0;                                                  
            u_ts = -u_m;
            //u_ts = 32000;
            //u_ts = sinus[ptr_sinus]/2 + 32768 - 24384;
            //Information für den da wandler von 0 bis 64k (-10,24-+10,24)

        // ohne Wegregelung
        //    u_ts = ((x_sinus[ptr_sinus] + 11200)*16 + 32768) ; //habe den sinus roh vorgegeben, finde es besser als mit regelung
            //if (u_ts > 40000) {u_ts = 40000;}
            //if (u_ts < 24000) {u_ts = 24000;}     
            adc_finish = 0;
            _LATC10 = 0;
        }
       // busy_old = ADC_BUSY;
    //}         
    }
}

// DAC

void __attribute__((__interrupt__, __auto_psv__)) _T2Interrupt(void) { 
    // Clear Timer 1 interrupt flag
    IFS0bits.T2IF = 0;          //Interrupt flag status, Anzeige einer Aktuellen interrupt anfrage
    //adc_measure();
    // Toggle LED on RD1
    _LATC10 = 1;
    DMA2CNT = 1;
    DMA3CNT = 1;
    //einstellungen für den DA-Wandler
    SPI2STATbits.SPIEN = 0;             // SPI Deaktivieren
    SPI2CON1bits.CKP = 0;               // Idle state for clock is a low level; active state is a high level (0)
                                        
    SPI2CON1bits.CKE = 1;               //zur Initialisierung der SPI, steuerung des Datentransfers
    SPI2STATbits.SPIEN = 1;             //SPI Aktivieren
    
    no_receive = 1;
    DAC_SS = 0;
    LATF = lockin_ref;  // output ref signal for lockin amp
 

    
    
    SPI1TxBuffA[0] = 0x0030;
    SPI1TxBuffA[1] = u_ts;
    
    //SPI1TxBuffA[1] = sinus[ptr_sinus]/2 + 32768 - 24384;
    //SPI1TxBuffA[1] ++;//= SPI1TxBuffA[1] + 1;
    
    DMA2CONbits.CHEN = 1;   // Enable DMA Channel
    DMA3CONbits.CHEN = 1;   // Enable DMA Channel
    DMA2REQbits.FORCE = 1;      //Beginn der DMA übertragung in den SPIRxBuffA
    
    while( DMA2REQbits.FORCE == 1 );   //while schleife wird benötigt, da programmablauf sonst nicht funktioniert    
    
    ptr_count++;
    if (ptr_count >= 1) {               //Frequenz der Tauchspule, wegregelung 62,5Hz wenn nur ein Zyklus
        ptr_sinus++;
        ptr_count = 0;
    }
    /*
    // MITTELWERT ÜBER 1 PERIODE
     
    if (ptr_sinus >= 128) {
        ptr_sinus = 0;
        count_uavg++;
        if (count_uavg >= 1) {
            uavg1outavg = uavg1out >> 0;
            uavg2outavg = uavg2out >> 0;
            uavg1out = 0;
            uavg2out = 0;
            count_uavg = 0;
        }
        uavg1out += uavg1 >> 7;
        uavg2out += uavg2 >> 7;
        uavg1 = 0;
        uavg2 = 0;
    }
    uavg1 += CH[5];
    uavg2 += CH[6];
    */
    
    // GLEITENDER MITTELWERT
    
    if (ptr_sinus >= 128) ptr_sinus = 0;
    
    m1 += (CH[5] >> 7) - (uli1[ptr_sinus] >> 7);
    uli1[ptr_sinus] = CH[5];
    
    m2 += (CH[6] >> 7) - (uli2[ptr_sinus] >> 7);
    uli2[ptr_sinus] = CH[6];
    
    switch (ptr_sinus) {
        case   0: lockin_ref = 0b00; break;
        case  32: lockin_ref = 0b10; break;
        case  64: lockin_ref = 0b11; break;
        case  96: lockin_ref = 0b01; break;
        default: break;
    }
    _LATC10 = 0;
}

void __attribute__((__interrupt__, __auto_psv__)) _T4Interrupt(void) { 
    // Clear Timer 1 interrupt flag
    IFS1bits.T4IF = 0;                      //warum IFS1bits? bei den anderen beiden Tiemern ist es IFS0
    //adc_measure();
    // Toggle LED on RD1
    _LATC10 = 1;
    DMA2CNT = 1;
    DMA3CNT = 1;
    //einstellungen für den DA-Wandler
    SPI2STATbits.SPIEN = 0;             // SPI Deaktivieren
    SPI2CON1bits.CKP = 0;               // Idle state for clock is a low level; active state is a high level (0)
                                        
    SPI2CON1bits.CKE = 1;               //zur Initialisierung der SPI, steuerung des Datentransfers
    SPI2STATbits.SPIEN = 1;             //SPI Aktivieren
    
    no_receive = 1;
    DAC_SS = 0;
    LATF = lockin_ref;  // output ref signal for lockin amp
    
    SPI1TxBuffA[0] = 0x0031;
    SPI1TxBuffA[1] = (uint16_t)xsoll;
    
    //SPI1TxBuffA[1] = sinus[ptr_sinus]/2 + 32768 - 24384;
    //SPI1TxBuffA[1] ++;//= SPI1TxBuffA[1] + 1;
    
    DMA2CONbits.CHEN = 1;   // Enable DMA Channel
    DMA3CONbits.CHEN = 1;   // Enable DMA Channel
    DMA2REQbits.FORCE = 1;      //Beginn der DMA übertragung in den SPIRxBuffA
    
    while( DMA2REQbits.FORCE == 1 );   //while schleife wird benötigt, da programmablauf sonst nicht funktioniert    
    _LATC10 = 0;
}

// ADC

void __attribute__((__interrupt__, __auto_psv__)) _T1Interrupt(void) {
    // Clear Timer 1 interrupt flag
    IFS0bits.T1IF = 0;

    
    DMA2CNT = 11;               //Legt die Länge des Datentransfers mit dem ADC fest (änderung der Länge des clock-Signals)
    DMA3CNT = 11;               //Legt die Länge des Datentransfers mit dem ADC fest (änderung der Länge des clock-Signals)
    no_receive = 0;
    ADC_CNV = 1;                //keine Treffer in Datenblättern
    ADC_CNV = 0;                //keine Treffer in Datenblättern
    IFS1bits.INT1IF = 0;     //?   //Interrupt Flag Status, triggert den ISR? muss manuell zurückgesetzt werden / INT1IF im datenblatt nicht gefunden (DMA, ADC)
    IEC1bits.INT1IE = 1;     //?   //Interrupt Enable Control Registers /scheint wichtig zu sein, im Datenblatt dma aber nicht vorhanden 
    trigger_adc = 1;
    //start_adc = 2;
    start_adc++;
    if (start_adc == 4) {
        start_adc = 0;
        counter++;
        if (counter >= period) {
            counter = 0;
            if (step > 16) {
                dir = -1;
            }
            if (step < -16) {
                dir = 1;
            }
           if (dir == -1) {
                step --;
            }
            if (dir == 1) {
                step ++;
            }
        }
    }
    
 //   _LATC10 = 0;
}

void __attribute__((__interrupt__,no_auto_psv)) _PWM1Interrupt() {
    
    // Clear Timer 1 interrupt flag
    IFS5bits.PWM1IF = 0; //Clear Flag for next interrupt
    
    _LATB7 = 1 - _LATB7;

}

void __attribute__((__interrupt__,no_auto_psv)) _PWM2Interrupt() {
    // Clear Timer 1 interrupt flag
    IFS5bits.PWM2IF = 0; //Clear Flag for next interrupt
    //_LATB7 = 1 - _LATB7;

    start_adc = 0;
}

void __attribute__((__interrupt__,no_auto_psv)) _DMA1Interrupt() {
  //  if (ecan_read_message(0) == 255)
    //WORD data[4] = {0x0000, 0x0000, 0x0000, 0x0000};
    imax = ecan_read_message(3);
    ioffset = ecan_read_message(4);
    //Kxp = ecan_read_message(3) / 256;
    //Kxi = ecan_read_message(4) / 256;
    // Periode für die Stromregelung wird eingelesen aus Labview 
    period = ecan_read_message(5)*2; // upcount at 2nd PWM cycle -> 4 KHz -> 2 KHz -> 0,5 ms per cycle -> multiplier: 2
    imode = ecan_read_message(6);
    //ecan_send_message(data,2,VALVE_ID);
    //    _LATB8 = 1 - _LATB8;
    
    C1RXFUL1bits.RXFUL10 = 0;
    C1RXFUL1 = 0;
    IFS0bits.DMA1IF = 0;
}


void __attribute__((__interrupt__)) _SPI2Interrupt(void) {
   // DMA2REQbits.FORCE=1;
    IFS2bits.SPI2IF = 0;  // teil der Setup prozedur für die SPI
}

void __attribute__((__interrupt__)) _INT1Interrupt(void) {
    IFS1bits.INT1IF = 0;
   // DMA2REQbits.FORCE=1;
  //  _LATC10 = 1- _LATC10;
    //if (trigger_adc == 1 && !ADC_BUSY) {
            //__delay_us(600);
            trigger_adc = 0;
            _LATB8 = 1;// - _LATB8;
            
            ADC_SS = 0;   // select ADC as SPI slave
            
            //if (start_adc == 1) {
            DMA2CONbits.CHEN = 1;   // Enable DMA Channel, essentiell für Funktion
            DMA3CONbits.CHEN = 1;   // Enable DMA Channel, vor beginn der Übertragung muss der DMA kanal aktiviert werden 
            DMA2REQbits.FORCE = 1;  // Die sendung der Daten wird initialisiert
            while( DMA2REQbits.FORCE == 1 );
   //     }
    IEC1bits.INT1IE = 0;                //Interrupt control bit, 
    _LATB8 = 1 - _LATB8;
}

void CfgDma0SpiTx( void ) {  //Initialisierungsmethode, wird nur am anfang aufgerufen?
    
    DMA2CON = 0x2002;
    DMA2CON = 0x2003;
    DMA2CON = 0x2001;
    DMA2CNT = 11;
    DMA2REQ = 10;
    DMA2REQ = 0x21;
    
    DMA2PAD = ( volatile uint16_t ) &SPI2BUF;
    #ifdef _HAS_DMA_
    DMA0STAL = ( uint16_t ) __builtin_dmaoffset( &SPI1TxBuffA );
    DMA0STAH = ( uint16_t ) __builtin_dmapage( &SPI1TxBuffA );

    DMA0STBL = ( uint16_t ) __builtin_dmaoffset( &SPI1TxBuffB );
    DMA0STBH = ( uint16_t ) __builtin_dmapage( &SPI1TxBuffB );

    #else
    DMA2STAL = ( uint16_t ) & SPI1TxBuffA;
    DMA2STAH = ( uint16_t ) & SPI1TxBuffA;

    DMA2STBL = ( uint16_t ) & SPI1TxBuffB;
    DMA2STBH = ( uint16_t ) & SPI1TxBuffB;
    #endif
    IFS1bits.DMA2IF = 0;    // Clear DMA interrupt
    IEC1bits.DMA2IE = 1;    // Enable DMA interrupt
    DMA2CONbits.CHEN = 1;   // Enable DMA Channel
}

void CfgDma1SpiRx( void ) {
    
    DMA3CON = 0x0002;
    DMA3CON = 0x0003;       //????
    DMA3CON = 0x0001;
    DMA3CNT = 11;    // 4x 24 bit -> 6x 16 bit
    DMA3REQ = 10;
    DMA3REQ = 0x21;
    DMA3PAD = ( volatile uint16_t ) &SPI2BUF;
    #ifdef _HAS_DMA_
    DMA1STAL = __builtin_dmaoffset( &SPI1RxBuffA );
    DMA1STAH = __builtin_dmapage( &SPI1RxBuffA );

    DMA1STBL = __builtin_dmaoffset( &SPI1RxBuffB );
    DMA1STBH = __builtin_dmapage( &SPI1RxBuffB );

    #else
    DMA3STAL = ( uint16_t ) & SPI1RxBuffA;
    DMA3STAH = ( uint16_t ) & SPI1RxBuffA;

    #endif
    IFS2bits.DMA3IF = 0;    // Clear DMA interrupt
    IEC2bits.DMA3IE = 1;    // Enable DMA interrupt
    DMA3CONbits.CHEN = 1;   // Enable DMA Channel
}

void CfgSpi1Master( void ) {

    ANSELAbits.ANSA4 = 0;

    SPI2CON1bits.CKP = 1;           //Setup SPI Datentransfer
    SPI2CON1bits.CKE = 1;           //Setup SPI Datentransfer
    //SPI2CON1bits.CKP = 0;
    //SPI2CON1bits.CKE = 1;
    SPI2CON1bits.MODE16 = 1;
    SPI2CON1bits.MSTEN = 1;         //Teil der Setup Prozedur für die SPI
    // SPI clock: 10 MHz (40 MIPS/4)
    SPI2CON1bits.SPRE = 0b111;  // Secondary prescale 1:1
    SPI2CON1bits.PPRE = 0b10;   // Primary prescale 4:1
    SPI2CON1bits.DISSDO = 0;
    SPI2CON1bits.DISSCK = 0;

    // •    Enable SPI module (SPI1STATbits.SPIEN=?)
    SPI2STATbits.SPIEN = 1;
    
    // Force First word after Enabling SPI
    DMA2REQbits.FORCE = 1;
    while( DMA2REQbits.FORCE == 1 );
}

void InitSPIBuff( void )
{
    uint16_t    i;

    for( i = 0; i < 12; i++ )
    {
        SPI1RxBuffA[i] = 0xDEED;
    }
    // 4x 24 bit -> 6x 16 bit
    // softspan: 111 -> +-10,24V
    SPI1TxBuffA[0] = 0x3000;    // DAC: command (4 bit): 0011, address (4 bit): 0000, data (8 bit) 
    SPI1TxBuffA[1] = 0x0031;    // DAC: data (8 bit), command (4 bit): 0011, address (4 bit): 0001
    SPI1TxBuffA[2] = 0x0000;    // DAC: data (16 bit)
    SPI1TxBuffA[3] = 0xFFFF;
    SPI1TxBuffA[4] = 0xFFFF;
    SPI1TxBuffA[5] = 0xFFFF;
    SPI1TxBuffA[6] = 0xFFFF;
    SPI1TxBuffA[7] = 0xFFFF;
    SPI1TxBuffA[8] = 0xFFFF;
    SPI1TxBuffA[9] = 0xFFFF;
    SPI1TxBuffA[10] = 0xFFFF;
    SPI1TxBuffA[11] = 0xFFFF;
    
    
    
}

void __attribute__ ( (interrupt, no_auto_psv) ) _DMA2Interrupt( void ) {
    IFS1bits.DMA2IF = 0;    // Clear the DMA0 Interrupt Flag;
   // DMA0CONbits.CHEN = 1;   // Enable DMA Channel
  //  _LATB8 = 1 - _LATB8;
  //  DMA0CONbits.CHEN = 0;   // Enable DMA Channel
  //  DMA1CONbits.CHEN = 0;   // Enable DMA Channel
}

void __attribute__ ( (interrupt, auto_psv) ) _DMA3Interrupt( void ) {
    
    IFS2bits.DMA3IF = 0;    // Clear the DMA1 Interrupt Flag
    _LATB8 = 0;
    ADC_SS = 1;     // deselect ADC as slave
    DAC_SS = 1;     // deselect DAC as slave
    
    SPI2STATbits.SPIEN = 0;     //SPI deaktivieren 
    SPI2CON1bits.CKP = 1;       // Idle state for clock is a low level; active state is a high level (0)
                                // input des Clock signals festlegen, Initialisierung der SPI
    SPI2CON1bits.CKE = 1;       // Serial output data changes on transition from Idle clock state to active clock state
                               // Output der SPI bei steigender Flanke (0) oder Fallender (1)
    SPI2STATbits.SPIEN = 1;    //SPI aktivieren
    
    if (!no_receive) {
        CH[0] = SPI1RxBuffA[0];
        CH[1] = ((SPI1RxBuffA[1] & 0x00FF) << 8) | ((SPI1RxBuffA[2] & 0xFF00) >> 8);
        CH[2] = SPI1RxBuffA[3]; 
        CH[3] = ((SPI1RxBuffA[4] & 0x00FF) << 8) | ((SPI1RxBuffA[5] & 0xFF00) >> 8);
        CH[4] = SPI1RxBuffA[6]; 
        CH[5] = ((SPI1RxBuffA[7] & 0x00FF) << 8) | ((SPI1RxBuffA[8] & 0xFF00) >> 8);
        CH[6] = SPI1RxBuffA[9]; 
        CH[7] = ((SPI1RxBuffA[10] & 0x00FF) << 8) | ((SPI1RxBuffA[11] & 0xFF00) >> 8);
        //Aufbereitung der Daten von der SPI in 24 bit, werden aber nur pro wert die ersten 16 benötigt

        if (start_adc == 1) {
            adc_i1 = CH[0];
        }

        if (start_adc == 2) {
            adc_i2 = CH[0];
        }

        //rxDmaBuffer ^= 1;
        if (start_adc == 3) {
         //   _LATB8 = 0;
            trigger_calc = 1;               //wird wieder auf 0 gesetzt, nachdem der Strom geregelt wurde
            if (counter_can < CYC_CAN) {
                counter_can++;
            } else {
                counter_can = 1;
                ecan_send_message(data,2,ECAN_ID);
            }
        }
        adc_finish = 1;
    }
}

void ProcessSpiRxSamples( __eds__ uint16_t *SpiRxBuffer ) {
}

void timer_dac_init(void) {

// TIMER 1

    T1CONbits.TON = 0;          // disable Timer 1
    T1CONbits.TCS = 0;          // Select internal instruction cycle clock
    T1CONbits.TGATE = 0;        // disable gated timer mode
    T1CONbits.TCKPS = 0b00;     // prescaler: 1:8
    TMR1 = 500;                // set start value of timer register
    PR1 = PERIOD_DAC - 1;           // load the period value -> 4 kHz
    
    IPC0bits.T1IP = 0x01;   // set timer 1 interrupt priority level
    IFS0bits.T1IF = 0;      // clear timer 1 interrupt flag
    IEC0bits.T1IE = 1;      // enable timer 1 interrupt  
    
    T1CONbits.TON = 1;      // enable Timer 1

// TIMER 2    

    T2CONbits.TON = 0;          // disable Timer 1
    T2CONbits.TCS = 0;          // Select internal instruction cycle clock
    T2CONbits.TGATE = 0;        // disable gated timer mode
    T2CONbits.TCKPS = 0b00;     // prescaler: 1:8
    TMR2 = PERIOD_DAC - 3125;                // set start value of timer register
    PR2 = PERIOD_DAC - 1;           // load the period value -> 4 kHz
    
    IPC1bits.T2IP = 0x01;   // set timer 1 interrupt priority level
    IFS0bits.T2IF = 0;      // clear timer 1 interrupt flag
    IEC0bits.T2IE = 1;      // enable timer 1 interrupt
    
    T2CONbits.TON = 1;      // enable Timer 1
    
// TIMER 4    

    T4CONbits.TON = 0;          // disable Timer 1
    T4CONbits.TCS = 0;          // Select internal instruction cycle clock
    T4CONbits.TGATE = 0;        // disable gated timer mode
    T4CONbits.TCKPS = 0b00;     // prescaler: 1:8
    TMR4 = PERIOD_DAC - 3200;                // set start value of timer register
    PR4 = PERIOD_DAC - 1;           // load the period value -> 4 kHz
    
    IPC6bits.T4IP = 0x01;   // set timer 1 interrupt priority level
    IFS1bits.T4IF = 0;      // clear timer 1 interrupt flag
    IEC1bits.T4IE = 1;      // enable timer 1 interrupt
    
    T4CONbits.TON = 1;      // enable Timer 1
    
// external interrupt INT1
    
    INTCON2bits.INT1EP = 1; // interrupt on negative edge
    IFS1bits.INT1IF = 0;      // clear INT1 interrupt flag
    IEC1bits.INT1IE = 1;      // enable INT1 interrupt
    ANSELE = 0x0000;
    
    
}